# Unified Experiment Config - 10K samples
# Switch between audio-only, MIDI-only, and fusion modes
# Usage: python train.py --config configs/experiment_10k.yaml --mode [audio|midi|fusion]

data:
  # LOCAL PATHS (after running scripts/copy_data_to_local.py)
  # Use /tmp/ for fast local SSD access (not Google Drive!)
  # IMPORTANT: Run `python scripts/copy_data_to_local.py` before training
  train_path: /tmp/crescendai_data/annotations/synthetic_train_filtered.jsonl
  val_path: /tmp/crescendai_data/annotations/synthetic_val_filtered.jsonl
  test_path: /tmp/crescendai_data/annotations/synthetic_test_filtered.jsonl

  # Reduced to 3 core dimensions for faster convergence
  dimensions:
    - note_accuracy      # MIDI can predict this
    - rhythmic_precision # MIDI can predict this
    - tone_quality       # Only audio can predict this (fusion advantage)

  audio_sample_rate: 24000
  max_audio_length: 240000  # 10 seconds at 24kHz
  max_midi_events: 512

  # OPTIMIZED for LOCAL SSD (10-30x faster than Google Drive!)
  batch_size: 16           # 2Ã— larger (faster epochs)
  num_workers: 4           # Parallel loading (was 0 for Drive, now 4 for local SSD)
  pin_memory: true         # Faster GPU transfer
  persistent_workers: true # Keep workers alive between epochs
  prefetch_factor: 2       # Pre-load batches

  # Minimal augmentation for speed (can increase later)
  augmentation:
    enabled: true
    pitch_shift:
      enabled: true
      probability: 0.2  # Reduced
      min_semitones: -1
      max_semitones: 1
    time_stretch:
      enabled: true
      probability: 0.2  # Reduced
      min_rate: 0.9
      max_rate: 1.1
    add_noise:
      enabled: true
      probability: 0.1  # Reduced
      min_snr_db: 30
      max_snr_db: 40
    gain_variation:
      enabled: true
      probability: 0.2
      min_db: -3
      max_db: 3
    # Disable slow augmentations
    room_acoustics:
      enabled: false
    compress_audio:
      enabled: false
    max_transforms: 2

model:
  # These will be overridden by --mode flag
  audio_dim: 768
  midi_dim: 256
  fusion_dim: 1024
  aggregator_dim: 512
  num_dimensions: 3

  # MERT settings
  mert_model_name: m-a-p/MERT-v1-95M
  freeze_audio_encoder: false
  gradient_checkpointing: true  # Essential for memory

  # MIDI encoder settings
  midi_hidden_size: 256
  midi_num_layers: 6
  midi_num_heads: 8

  # Fusion settings
  fusion_num_heads: 8
  fusion_dropout: 0.1

  # Aggregation
  lstm_hidden: 256
  lstm_layers: 2
  attention_heads: 4
  aggregator_dropout: 0.2

  # MTL head
  shared_hidden: 256
  task_hidden: 128
  mtl_dropout: 0.1

training:
  max_epochs: 5            # Just enough to see convergence
  precision: 16            # Mixed precision (faster + less memory)
  optimizer: AdamW
  learning_rate: 1e-5      # Conservative for MERT
  backbone_lr: 1e-5        # MERT learning rate
  heads_lr: 1e-4           # Task heads learn faster
  weight_decay: 0.01
  scheduler: cosine
  warmup_steps: 100        # Reduced (fewer total steps)
  min_lr: 1e-6
  gradient_clip_val: 1.0
  accumulate_grad_batches: 2  # Effective batch = 32

  # Validation
  val_check_interval: 1.0  # Validate every epoch
  limit_val_batches: 1.0   # Use full validation set
  track_correlations: true # Log Pearson/Spearman correlations

callbacks:
  checkpoint:
    monitor: val_loss
    mode: min
    save_top_k: 1          # Only save best (save Drive space)
    save_last: true
    dirpath: /content/drive/MyDrive/crescendai_checkpoints/{mode}_10k
    filename: '{mode}-{epoch:02d}-{val_loss:.4f}'
  early_stopping:
    monitor: val_loss
    mode: min
    patience: 3            # Stop if no improvement for 3 epochs
    min_delta: 0.001
  lr_monitor:
    logging_interval: step

logging:
  log_every_n_steps: 25
  use_wandb: false         # Disable for now (can enable later)
  use_tensorboard: true
  tensorboard_logdir: logs/{mode}_10k

seed: 42

# Mode-specific overrides (applied by train.py)
modes:
  audio:
    use_midi: false
    use_fusion: false
    midi_dim: 0
    fusion_dim: 768        # Just audio features

  midi:
    use_midi: true
    use_fusion: false
    audio_dim: 0
    fusion_dim: 256        # Just MIDI features

  fusion:
    use_midi: true
    use_fusion: true
    # Use default dimensions (audio=768, midi=256, fusion=1024)
